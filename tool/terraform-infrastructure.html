<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraform 基础设施即代码 - 系统改造自动化工具</title>
    <meta name="description" content="使用 Terraform 进行内部系统改造，通过基础设施即代码实现系统环境的自动化创建和管理">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header class="site-header">
        <div class="container">
            <h1 class="site-title">内部系统改造框架</h1>
            <nav class="main-nav">
                <a href="/guide/">指南</a>
                <a href="/tool/">工具</a>
                <a href="/compare/">对比</a>
                <a href="/live/">实战</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="breadcrumb">
            <a href="/">首页</a> / <a href="/tool/">工具</a> / <span>Terraform 基础设施</span>
        </div>

        <div class="page-content">
            <h1>Terraform 基础设施即代码 - 系统改造自动化工具</h1>
            
            <p>Terraform 是进行内部系统改造的强大工具，通过基础设施即代码（IaC）实现系统环境的自动化创建、修改和管理。本文将详细介绍如何使用 Terraform 进行系统改造。</p>

            <h2>为什么使用 Terraform 进行系统改造？</h2>
            <p>Terraform 为内部系统改造提供了声明式的基础设施管理：</p>
            <ul>
                <li><strong>声明式配置：</strong>描述期望状态，自动实现</li>
                <li><strong>版本控制：</strong>基础设施配置可版本化管理</li>
                <li><strong>多平台支持：</strong>支持 AWS、Azure、GCP 等</li>
                <li><strong>状态管理：</strong>跟踪基础设施变更</li>
            </ul>

            <h2>Terraform 系统改造实战</h2>

            <h3>1. 定义基础设施配置</h3>
            <p>创建 main.tf 文件定义系统环境：</p>
            <pre><code># main.tf - 系统改造环境配置
terraform {
  required_version = ">= 1.0"
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "us-east-1"
}

# VPC 网络配置
resource "aws_vpc" "transformation_vpc" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name = "transformation-simulation-env"
    Type = "simulation"
  }
}

# 子网配置
resource "aws_subnet" "public_subnet" {
  vpc_id            = aws_vpc.transformation_vpc.id
  cidr_block        = "10.0.1.0/24"
  availability_zone = "us-east-1a"

  tags = {
    Name = "public-subnet"
  }
}

# EC2 实例 - 应用服务器
resource "aws_instance" "app_server" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t3.medium"

  subnet_id              = aws_subnet.public_subnet.id
  vpc_security_group_ids = [aws_security_group.app_sg.id]

  user_data = <<-EOF
              #!/bin/bash
              yum update -y
              yum install -y docker
              systemctl start docker
              systemctl enable docker
              docker run -d -p 80:80 nginx:alpine
              EOF

  tags = {
    Name = "transformation-app-server"
    Role = "application"
  }
}

# 安全组配置
resource "aws_security_group" "app_sg" {
  name        = "transformation-app-sg"
  description = "Security group for transformation environment"
  vpc_id      = aws_vpc.transformation_vpc.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "transformation-app-sg"
  }
}

# RDS 数据库实例
resource "aws_db_instance" "transformation_db" {
  identifier     = "transformation-db"
  engine         = "postgres"
  engine_version = "15.4"
  instance_class = "db.t3.micro"

  allocated_storage     = 20
  storage_type         = "gp3"
  storage_encrypted     = true

  db_name  = "transformation_db"
  username = "admin"
  password = var.db_password

  vpc_security_group_ids = [aws_security_group.db_sg.id]
  db_subnet_group_name   = aws_db_subnet_group.main.name

  backup_retention_period = 7
  skip_final_snapshot     = true

  tags = {
    Name = "transformation-database"
    Type = "simulation"
  }
}

# 数据库子网组
resource "aws_db_subnet_group" "main" {
  name       = "transformation-db-subnet-group"
  subnet_ids = [aws_subnet.public_subnet.id]

  tags = {
    Name = "transformation-db-subnet-group"
  }
}

# 数据库安全组
resource "aws_security_group" "db_sg" {
  name        = "transformation-db-sg"
  description = "Security group for database"
  vpc_id      = aws_vpc.transformation_vpc.id

  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.app_sg.id]
  }

  tags = {
    Name = "transformation-db-sg"
  }
}</code></pre>

            <h3>2. 定义变量</h3>
            <p>创建 variables.tf 定义可配置变量：</p>
            <pre><code># variables.tf
variable "db_password" {
  description = "Database password"
  type        = string
  sensitive   = true
}

variable "environment" {
  description = "Environment type"
  type        = string
  default     = "simulation"
}

variable "instance_type" {
  description = "EC2 instance type"
  type        = string
  default     = "t3.medium"
}</code></pre>

            <h3>3. 执行 Terraform 部署</h3>
            <p>使用 Terraform 命令创建环境：</p>
            <pre><code># 初始化 Terraform
terraform init

# 验证配置
terraform validate

# 查看执行计划
terraform plan

# 应用配置，创建环境
terraform apply

# 查看输出
terraform output

# 销毁环境（测试完成后）
terraform destroy</code></pre>

            <h3>4. 改造环境管理</h3>
            <p>使用 Terraform 管理改造环境：</p>
            <pre><code># 查看当前状态
terraform show

# 修改配置后重新应用
terraform apply

# 使用工作区管理多个环境
terraform workspace new dev
terraform workspace new staging
terraform workspace new production

# 切换工作区
terraform workspace select dev</code></pre>

            <h2>Terraform 高级功能</h2>

            <h3>1. 模块化配置</h3>
            <p>创建可复用的模块：</p>
            <pre><code># modules/web-server/main.tf
variable "instance_type" {
  type = string
}

resource "aws_instance" "web" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = var.instance_type
  # ... 其他配置
}

# 使用模块
module "web_server" {
  source = "./modules/web-server"
  
  instance_type = "t3.large"
}</code></pre>

            <h3>2. 状态管理</h3>
            <p>使用远程状态存储：</p>
            <pre><code># backend.tf
terraform {
  backend "s3" {
    bucket = "transformation-terraform-state"
    key    = "environments/simulation/terraform.tfstate"
    region = "us-east-1"
  }
}</code></pre>

            <h3>3. 条件资源创建</h3>
            <p>根据条件创建资源：</p>
            <pre><code>resource "aws_instance" "optional_server" {
  count = var.create_optional ? 1 : 0
  
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t3.small"
  # ... 其他配置
}</code></pre>

            <h2>Terraform 实际应用案例</h2>

            <h3>案例：多环境系统改造</h3>
            <p>使用 Terraform 管理开发、测试、生产环境：</p>
            <pre><code># environments/dev/main.tf
module "infrastructure" {
  source = "../../modules/infrastructure"
  
  environment = "development"
  instance_type = "t3.small"
  db_instance_class = "db.t3.micro"
}

# environments/prod/main.tf
module "infrastructure" {
  source = "../../modules/infrastructure"
  
  environment = "production"
  instance_type = "t3.xlarge"
  db_instance_class = "db.r5.large"
}</code></pre>

            <h2>Terraform 工具的优势</h2>
            <ul>
                <li><strong>声明式配置：</strong>描述期望状态，自动实现</li>
                <li><strong>多平台支持：</strong>统一管理不同云平台</li>
                <li><strong>版本控制：</strong>基础设施配置可追踪</li>
                <li><strong>自动化：</strong>减少手动操作错误</li>
            </ul>

            <h2>相关资源</h2>
            <p>继续学习：</p>
            <ul>
                <li><a href="/compare/terraform-vs-ansible" class="internal-link">Terraform vs Ansible</a> - 基础设施工具对比</li>
                <li><a href="/tool/docker-simulation" class="internal-link">Docker 模拟环境</a> - 容器化工具</li>
                <li><a href="/guide/environment-configuration" class="internal-link">环境配置指南</a> - 配置最佳实践</li>
            </ul>

            <p>想了解其他工具？查看 <a href="/tool/system-transformation-tools" class="internal-link">内部系统改造工具推荐</a>。需要实际案例？查看 <a href="/live/" class="internal-link">实战项目</a>。</p>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2024 内部系统改造框架. 专业改造解决方案中心。</p>
        </div>
    </footer>
</body>
</html>
